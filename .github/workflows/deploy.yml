name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --no-audit
          echo "âœ… Dependencias instaladas"

      - name: ğŸ” Verificar estructura del proyecto
        run: |
          echo "=== ESTRUCTURA DEL PROYECTO ==="
          find . -type f -name "*.scss" -o -name "*.css" | sort
          echo ""
          echo "=== CONTENIDO src/scss/ ==="
          ls -la src/scss/ || echo "âŒ Directorio src/scss/ no existe"
          echo ""
          echo "=== VERIFICANDO main.scss ==="
          if [ -f "src/scss/main.scss" ]; then
            echo "âœ… main.scss encontrado"
            head -20 src/scss/main.scss
          else
            echo "âŒ main.scss NO encontrado"
            echo "Creando archivo main.scss bÃ¡sico..."
            mkdir -p src/scss
            echo "/* Main SCSS File */" > src/scss/main.scss
            echo "@import 'components/profile';" >> src/scss/main.scss
            echo "@import 'components/hero';" >> src/scss/main.scss
            echo "@import 'components/footer';" >> src/scss/main.scss
            echo "@import 'components/intro';" >> src/scss/main.scss
          fi

      - name: ğŸ¨ Compilar SCSS (Desarrollo)
        run: |
          echo "=== COMPILANDO SCSS ==="
          npx gulp styles 2>&1 || {
            echo "âŒ Error durante la compilaciÃ³n"
            exit 1
          }

      - name: ğŸ“„ Verificar archivos generados
        run: |
          echo "=== ARCHIVOS GENERADOS ==="
          if [ -d "assets/css" ]; then
            echo "âœ… Directorio assets/css existe"
            ls -la assets/css/
            echo ""
            echo "=== CONTENIDO DE main.css ==="
            if [ -f "assets/css/main.css" ]; then
              echo "âœ… main.css generado correctamente"
              echo "TamaÃ±o: $(wc -l < assets/css/main.css) lÃ­neas"
              echo "Primeras 10 lÃ­neas:"
              head -10 assets/css/main.css
            else
              echo "âŒ main.css NO generado"
              exit 1
            fi
          else
            echo "âŒ Directorio assets/css NO existe"
            exit 1
          fi

      - name: ğŸ—‚ï¸ Preparar archivos para Pages
        run: |
          echo "=== PREPARANDO PARA GITHUB PAGES ==="
          
          # Crear directorio para el deploy
          mkdir -p _site
          
          # 1. COPIAR PÃGINAS HTML ORGANIZADAS POR IDIOMAS
          echo "=== COPIANDO PÃGINAS POR IDIOMAS ==="
          
          if [ -d "src/pages" ]; then
            echo "ğŸ“ Estructura encontrada: src/pages/"
          
            # EspaÃ±ol (es)
            if [ -d "src/pages/es" ]; then
              mkdir -p _site/es
              # Copiar todos los archivos HTML
              cp src/pages/es/*.html _site/es/ 2>/dev/null || true
              # Copiar otros recursos si existen (subcarpetas, imÃ¡genes, etc.)
              find src/pages/es -maxdepth 1 -type d ! -name '.' ! -name 'es' | while read dir; do
                dir_name=$(basename "$dir")
                cp -r "$dir" _site/es/ 2>/dev/null || true
              done
              echo "âœ… EspaÃ±ol copiado: $(ls _site/es/*.html 2>/dev/null | wc -l) archivos HTML"
            fi
          
            # InglÃ©s (en)
            if [ -d "src/pages/en" ]; then
              mkdir -p _site/en
              cp src/pages/en/*.html _site/en/ 2>/dev/null || true
              find src/pages/en -maxdepth 1 -type d ! -name '.' ! -name 'en' | while read dir; do
                dir_name=$(basename "$dir")
                cp -r "$dir" _site/en/ 2>/dev/null || true
              done
              echo "âœ… InglÃ©s copiado: $(ls _site/en/*.html 2>/dev/null | wc -l) archivos HTML"
            fi
          
            # FrancÃ©s (fr)
            if [ -d "src/pages/fr" ]; then
              mkdir -p _site/fr
              cp src/pages/fr/*.html _site/fr/ 2>/dev/null || true
              find src/pages/fr -maxdepth 1 -type d ! -name '.' ! -name 'fr' | while read dir; do
                dir_name=$(basename "$dir")
                cp -r "$dir" _site/fr/ 2>/dev/null || true
              done
              echo "âœ… FrancÃ©s copiado: $(ls _site/fr/*.html 2>/dev/null | wc -l) archivos HTML"
            fi
          else
            echo "âš ï¸ No se encontrÃ³ la estructura src/pages/"
          fi
          
          # 2. COPIAR LANDING PAGE DE REDIRECCIÃ“N
          echo ""
          echo "=== COPIANDO LANDING PAGE ==="
          
          # Verificar si ya existe un index.html en la raÃ­z del proyecto
          if [ -f "index.html" ]; then
            # Copiar la landing page existente
            cp index.html _site/
            echo "âœ… Landing page copiada desde index.html"
          elif [ -f "src/index.html" ]; then
            # O si estÃ¡ en src/
            cp src/index.html _site/
            echo "âœ… Landing page copiada desde src/index.html"
          else
            # Crear una landing page bÃ¡sica si no existe
            echo "âš ï¸ No se encontrÃ³ landing page, creando una bÃ¡sica..."
            cat > _site/index.html << 'EOF'
  <!DOCTYPE html>
  <html lang="es">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coaching Site | Selecciona Idioma</title>
  <link rel="stylesheet" href="assets/css/main.css">
  <style>
  :root {
--primary-color: #667eea;
--secondary-color: #764ba2;
}
  
  .language-landing {
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
min-height: 100vh;
background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
color: white;
text-align: center;
padding: 2rem;
}
  
  .language-landing h1 {
font-size: 3rem;
margin-bottom: 1rem;
}
  
  .language-landing p {
font-size: 1.2rem;
margin-bottom: 3rem;
max-width: 600px;
opacity: 0.9;
}
  
  .language-options {
display: flex;
gap: 1.5rem;
flex-wrap: wrap;
justify-content: center;
margin-bottom: 2rem;
}
  
  .language-card {
background: rgba(255, 255, 255, 0.1);
backdrop-filter: blur(10px);
border-radius: 15px;
padding: 2rem;
min-width: 200px;
text-decoration: none;
color: white;
transition: transform 0.3s ease, box-shadow 0.3s ease;
border: 1px solid rgba(255, 255, 255, 0.2);
}
  
  .language-card:hover {
transform: translateY(-10px);
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
background: rgba(255, 255, 255, 0.15);
}
  
  .language-flag {
font-size: 3rem;
margin-bottom: 1rem;
}
  
  .language-name {
font-size: 1.5rem;
font-weight: bold;
margin-bottom: 0.5rem;
}
  
  .auto-redirect {
margin-top: 2rem;
font-size: 0.9rem;
opacity: 0.8;
}
  
  .redirect-timer {
font-weight: bold;
color: #ffd700;
}
  
  @media (max-width: 768px) {
     .language-landing h1 {
     font-size: 2rem;
}
     
     .language-card {
     padding: 1.5rem;
     min-width: 150px;
}
}
  </style>
  </head>
  <body>
  <div class="language-landing">
  <h1>ğŸŒ Coaching Internacional</h1>
  <p>Selecciona tu idioma preferido para acceder a los recursos de coaching personalizado</p>
  
  <div class="language-options">
  <a href="es/index.html" class="language-card">
  <div class="language-flag">ğŸ‡ªğŸ‡¸</div>
  <div class="language-name">EspaÃ±ol</div>
  <div>Acceder al sitio en espaÃ±ol</div>
  </a>
  
  <a href="en/index.html" class="language-card">
  <div class="language-flag">ğŸ‡¬ğŸ‡§</div>
  <div class="language-name">English</div>
  <div>Access the site in English</div>
  </a>
  
  <a href="fr/index.html" class="language-card">
  <div class="language-flag">ğŸ‡«ğŸ‡·</div>
  <div class="language-name">FranÃ§ais</div>
  <div>AccÃ©der au site en franÃ§ais</div>
  </a>
  </div>
  
  <div class="auto-redirect">
  Redirigiendo automÃ¡ticamente al idioma de tu navegador en <span class="redirect-timer" id="countdown">5</span> segundos...
  </div>
  </div>
  
  <script>
  // Detectar idioma del navegador
  const userLang = navigator.language || navigator.userLanguage;
  const supportedLangs = ['es', 'en', 'fr'];
  const defaultLang = 'es';

// Extraer cÃ³digo de idioma (ej: "es-ES" -> "es")
  const langCode = userLang.split('-')[0];
const targetLang = supportedLangs.includes(langCode) ? langCode : defaultLang;
  
  // Contador para redirecciÃ³n automÃ¡tica
  let seconds = 5;
  const countdownEl = document.getElementById('countdown');
  
  const countdown = setInterval(() => {
  seconds--;
  countdownEl.textContent = seconds;
  
  if (seconds <= 0) {
  clearInterval(countdown);
  window.location.href = `${targetLang}/index.html`;
  }
}, 1000);
  
  // Cancelar redirecciÃ³n si el usuario interactÃºa
  document.querySelectorAll('.language-card').forEach(link => {
  link.addEventListener('click', () => {
  clearInterval(countdown);
  countdownEl.textContent = '0';
  });
});
  </script>
  </body>
  </html>
  EOF
  echo "âœ… Landing page bÃ¡sica creada"
  fi
  
  # 3. COPIAR ASSETS COMPILADOS (CSS, JS, IMÃGENES)
  echo ""
  echo "=== COPIANDO ASSETS ==="
  
  # CSS compilado
  if [ -d "assets/css" ]; then
  mkdir -p _site/assets/css
  cp assets/css/*.css _site/assets/css/ 2>/dev/null || true
echo "âœ… CSS copiado: $(ls _site/assets/css/*.css 2>/dev/null | wc -l) archivos"

# Verificar el contenido del CSS copiado
  echo "=== VERIFICANDO CSS COPIADO ==="
  if [ -f "_site/assets/css/main.css" ]; then
  echo "âœ… main.css encontrado en _site"
echo "ğŸ“Š TamaÃ±o: $(wc -l < _site/assets/css/main.css) lÃ­neas"
  echo "ğŸ“„ Primeras 5 lÃ­neas:"
  head -5 _site/assets/css/main.css
  else
echo "âŒ ERROR: main.css no se copiÃ³ a _site/"
  ls -la _site/assets/css/ 2>/dev/null || echo "âŒ Directorio _site/assets/css/ no existe"
  exit 1
  fi
  else
echo "âŒ ERROR: No se encontrÃ³ assets/css/"
  exit 1
  fi
  
  # JS si existe
  if [ -d "assets/js" ]; then
  mkdir -p _site/assets/js
  cp assets/js/*.js _site/assets/js/ 2>/dev/null || true
  echo "âœ… JavaScript copiado"
  elif [ -d "js" ]; then
  cp -r js _site/ 2>/dev/null || true
  echo "âœ… JavaScript copiado desde js/"
  fi
  
  # ImÃ¡genes
  if [ -d "assets/images" ]; then
  mkdir -p _site/assets/images
  cp -r assets/images/* _site/assets/images/ 2>/dev/null || true
  echo "âœ… ImÃ¡genes copiadas"
  elif [ -d "images" ]; then
  cp -r images _site/ 2>/dev/null || true
  echo "âœ… ImÃ¡genes copiadas desde images/"
  fi
  
  # Iconos (CORREGIDO: tenÃ­a 'iconss' en lugar de 'icons')
  if [ -d "assets/icons" ]; then
  mkdir -p _site/assets/icons
  cp -r assets/icons/* _site/assets/icons/ 2>/dev/null || true
  echo "âœ… Iconos copiados"
  elif [ -d "icons" ]; then
  cp -r icons _site/ 2>/dev/null || true
  echo "âœ… Iconos copiados desde icons/"
  fi
  
  # Fuentes
  if [ -d "assets/fonts" ]; then
  mkdir -p _site/assets/fonts
  cp -r assets/fonts/* _site/assets/fonts/ 2>/dev/null || true
  echo "âœ… Fuentes copiadas"
  elif [ -d "fonts" ]; then
  cp -r fonts _site/ 2>/dev/null || true
  echo "âœ… Fuentes copiadas desde fonts/"
  fi
  
  # 4. VERIFICAR ESTRUCTURA FINAL
  echo ""
  echo "=== ESTRUCTURA FINAL DEL SITIO ==="
  echo "_site/"
  find _site -type f | sort
  
  echo ""
  echo "=== RESUMEN ==="
echo "ğŸ“„ Landing page: _site/index.html"
echo "ğŸ‡ªğŸ‡¸ EspaÃ±ol: $(ls _site/es/*.html 2>/dev/null | wc -l) pÃ¡ginas"
echo "ğŸ‡¬ğŸ‡§ InglÃ©s: $(ls _site/en/*.html 2>/dev/null | wc -l) pÃ¡ginas"
echo "ğŸ‡«ğŸ‡· FrancÃ©s: $(ls _site/fr/*.html 2>/dev/null | wc -l) pÃ¡ginas"
echo "ğŸ¨ CSS: $(ls _site/assets/css/*.css 2>/dev/null | wc -l) archivos"

- name: ğŸ“¦ Crear artifact de compilaciÃ³n
  uses: actions/upload-artifact@v4
  with:
    name: site-build
    path: _site/
    retention-days: 7
  if: success()

deploy:
  needs: build-and-test
  if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
  runs-on: ubuntu-latest
  permissions:
    contents: write
  
  steps:
    - name: ğŸ›ï¸ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“¦ Descargar artifact del build
      uses: actions/download-artifact@v4
      with:
        name: site-build
        path: _site/

    - name: âœ… Verificar archivos para deploy
      run: |
        echo "=== ARCHIVOS PARA DEPLOY ==="
        ls -la _site/
        echo ""
        echo "=== VERIFICANDO CSS ==="
        if [ -f "_site/assets/css/main.css" ]; then
          echo "âœ… main.css presente"
          echo "ğŸ“Š TamaÃ±o: $(wc -l < _site/assets/css/main.css) lÃ­neas"
        else
          echo "âŒ ERROR: main.css no encontrado"
          echo "Contenido de _site/assets/css/:"
          ls -la _site/assets/css/ 2>/dev/null || echo "Directorio no existe"
          exit 1
        fi
        
        echo ""
        echo "=== ESTRUCTURA COMPLETA ==="
        find _site -type f | sort

    - name: ğŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./_site
        force_orphan: true
        publish_branch: gh-pages

    - name: ğŸ“¢ Notificar despliegue
      run: |
        echo "âœ… Sitio desplegado en GitHub Pages"
        echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"