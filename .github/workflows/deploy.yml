name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚éî Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          npm ci --no-audit
          echo "‚úÖ Dependencias instaladas"

      - name: üîç Verificar estructura del proyecto
        run: |
          echo "=== ESTRUCTURA DEL PROYECTO ==="
          find . -type f -name "*.scss" -o -name "*.css" | sort
          echo ""
          echo "=== CONTENIDO src/scss/ ==="
          ls -la src/scss/ || echo "‚ùå Directorio src/scss/ no existe"
          echo ""
          echo "=== VERIFICANDO main.scss ==="
          if [ -f "src/scss/main.scss" ]; then
            echo "‚úÖ main.scss encontrado"
            head -20 src/scss/main.scss
          else
            echo "‚ùå main.scss NO encontrado"
            echo "Creando archivo main.scss b√°sico..."
            mkdir -p src/scss
            echo "/* Main SCSS File */" > src/scss/main.scss
            echo "@import 'components/profile';" >> src/scss/main.scss
            echo "@import 'components/hero';" >> src/scss/main.scss
            echo "@import 'components/footer';" >> src/scss/main.scss
            echo "@import 'components/intro';" >> src/scss/main.scss
          fi

      - name: üé® Compilar SCSS (Desarrollo)
        run: |
          echo "=== COMPILANDO SCSS ==="
          npx gulp styles 2>&1 || {
            echo "‚ùå Error durante la compilaci√≥n"
            exit 1
          }

      - name: üìÑ Verificar archivos generados
        run: |
          echo "=== ARCHIVOS GENERADOS ==="
          if [ -d "assets/css" ]; then
            echo "‚úÖ Directorio assets/css existe"
            ls -la assets/css/
            echo ""
            echo "=== CONTENIDO DE main.css ==="
            if [ -f "assets/css/main.css" ]; then
              echo "‚úÖ main.css generado correctamente"
              echo "Tama√±o: $(wc -l < assets/css/main.css) l√≠neas"
              echo "Primeras 10 l√≠neas:"
              head -10 assets/css/main.css
            else
              echo "‚ùå main.css NO generado"
              exit 1
            fi
          else
            echo "‚ùå Directorio assets/css NO existe"
            exit 1
          fi

      - name: üóÇÔ∏è Preparar archivos para Pages
          run: |
            echo "=== PREPARANDO PARA GITHUB PAGES ==="
            
            # Crear directorio para el deploy
            mkdir -p _site
            
            # 1. COPIAR P√ÅGINAS HTML ORGANIZADAS POR IDIOMAS
            echo "=== COPIANDO P√ÅGINAS POR IDIOMAS ==="
            
            if [ -d "src/pages" ]; then
              echo "üìÅ Estructura encontrada: src/pages/"
            
              # Espa√±ol (es)
              if [ -d "src/pages/es" ]; then
                mkdir -p _site/es
                # Copiar todos los archivos HTML
                cp src/pages/es/*.html _site/es/ 2>/dev/null || true
                # Copiar otros recursos si existen (subcarpetas, im√°genes, etc.)
                find src/pages/es -maxdepth 1 -type d ! -name '.' ! -name 'es' | while read dir; do
                  dir_name=$(basename "$dir")
                  cp -r "$dir" _site/es/ 2>/dev/null || true
                done
                echo "‚úÖ Espa√±ol copiado: $(ls _site/es/*.html 2>/dev/null | wc -l) archivos HTML"
              fi
            
              # Ingl√©s (en)
              if [ -d "src/pages/en" ]; then
                mkdir -p _site/en
                cp src/pages/en/*.html _site/en/ 2>/dev/null || true
                find src/pages/en -maxdepth 1 -type d ! -name '.' ! -name 'en' | while read dir; do
                  dir_name=$(basename "$dir")
                  cp -r "$dir" _site/en/ 2>/dev/null || true
                done
                echo "‚úÖ Ingl√©s copiado: $(ls _site/en/*.html 2>/dev/null | wc -l) archivos HTML"
              fi
            
              # Franc√©s (fr)
              if [ -d "src/pages/fr" ]; then
                mkdir -p _site/fr
                cp src/pages/fr/*.html _site/fr/ 2>/dev/null || true
                find src/pages/fr -maxdepth 1 -type d ! -name '.' ! -name 'fr' | while read dir; do
                  dir_name=$(basename "$dir")
                  cp -r "$dir" _site/fr/ 2>/dev/null || true
                done
                echo "‚úÖ Franc√©s copiado: $(ls _site/fr/*.html 2>/dev/null | wc -l) archivos HTML"
              fi
            else
              echo "‚ö†Ô∏è No se encontr√≥ la estructura src/pages/"
            fi
            
            # 2. COPIAR LANDING PAGE DE REDIRECCI√ìN
            echo ""
            echo "=== COPIANDO LANDING PAGE ==="
            
            # Verificar si ya existe un index.html en la ra√≠z del proyecto
            if [ -f "index.html" ]; then
              # Copiar la landing page existente
              cp index.html _site/
              echo "‚úÖ Landing page copiada desde index.html"
            elif [ -f "src/index.html" ]; then
              # O si est√° en src/
              cp src/index.html _site/
              echo "‚úÖ Landing page copiada desde src/index.html"
            else
              # Crear una landing page b√°sica si no existe
              echo "‚ö†Ô∏è No se encontr√≥ landing page, creando una b√°sica..."
              cat > _site/index.html << 'EOF'
                  <!DOCTYPE html>
                  <html lang="es">
                  <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>Coaching Site | Selecciona Idioma</title>
                  <link rel="stylesheet" href="assets/css/main.css">
                  <style>
                  :root {
                  --primary-color: #667eea;
                  --secondary-color: #764ba2;
              }
                
                .language-landing {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
                color: white;
                text-align: center;
                padding: 2rem;
              }
                
                .language-landing h1 {
                font-size: 3rem;
                margin-bottom: 1rem;
              }
                
                .language-landing p {
                font-size: 1.2rem;
                margin-bottom: 3rem;
                max-width: 600px;
                opacity: 0.9;
              }
                
                .language-options {
                display: flex;
                gap: 1.5rem;
                flex-wrap: wrap;
                justify-content: center;
                margin-bottom: 2rem;
              }
                
                .language-card {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                padding: 2rem;
                min-width: 200px;
                text-decoration: none;
                color: white;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                border: 1px solid rgba(255, 255, 255, 0.2);
              }
                
                .language-card:hover {
                transform: translateY(-10px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
                background: rgba(255, 255, 255, 0.15);
              }
                
                .language-flag {
                font-size: 3rem;
                margin-bottom: 1rem;
              }
                
                .language-name {
                font-size: 1.5rem;
                font-weight: bold;
                margin-bottom: 0.5rem;
              }
                
                .auto-redirect {
                margin-top: 2rem;
                font-size: 0.9rem;
                opacity: 0.8;
              }
                
                .redirect-timer {
                font-weight: bold;
                color: #ffd700;
              }
                
                @media (max-width: 768px) {
                   .language-landing h1 {
                   font-size: 2rem;
              }
                
                .language-card {
                padding: 1.5rem;
                min-width: 150px;
              }
              }
                </style>
                </head>
                <body>
                <div class="language-landing">
                <h1>üåç Coaching Internacional</h1>
                <p>Selecciona tu idioma preferido para acceder a los recursos de coaching personalizado</p>
                
                <div class="language-options">
                <a href="es/index.html" class="language-card">
                <div class="language-flag">üá™üá∏</div>
                <div class="language-name">Espa√±ol</div>
                <div>Acceder al sitio en espa√±ol</div>
                </a>
                
                <a href="en/index.html" class="language-card">
                <div class="language-flag">üá¨üáß</div>
                <div class="language-name">English</div>
                <div>Access the site in English</div>
                </a>
                
                <a href="fr/index.html" class="language-card">
                <div class="language-flag">üá´üá∑</div>
                <div class="language-name">Fran√ßais</div>
                <div>Acc√©der au site en fran√ßais</div>
                </a>
                </div>
                
                <div class="auto-redirect">
                Redirigiendo autom√°ticamente al idioma de tu navegador en <span class="redirect-timer" id="countdown">5</span> segundos...
                </div>
                </div>
                
                <script>
                // Detectar idioma del navegador
                const userLang = navigator.language || navigator.userLanguage;
                const supportedLangs = ['es', 'en', 'fr'];
                const defaultLang = 'es';
                
                // Extraer c√≥digo de idioma (ej: "es-ES" -> "es")
                const langCode = userLang.split('-')[0];
                const targetLang = supportedLangs.includes(langCode) ? langCode: defaultLang;
                
                // Contador para redirecci√≥n autom√°tica
                let seconds = 5;
                const countdownEl = document.getElementById('countdown');
                
                const countdown = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;
                
                if (seconds <= 0) {
                clearInterval(countdown);
                window.location.href = `${targetLang}/index.html`;
              }
              }, 1000);
                
                // Cancelar redirecci√≥n si el usuario interact√∫a
                document.querySelectorAll('.language-card').forEach(link => {
                link.addEventListener('click', () => {
                clearInterval(countdown);
                countdownEl.textContent = '0';
              });
              });
                </script>
                </body>
                </html>
    EOF
    echo "‚úÖ Landing page b√°sica creada"
    fi
    
    # 3. COPIAR ASSETS COMPILADOS (CSS, JS, IM√ÅGENES)
    echo ""
    echo "=== COPIANDO ASSETS ==="
    
    # CSS compilado
    if [ -d "assets/css" ]; then
    mkdir -p _site/assets/css
    cp assets/css/*.css _site/assets/css/ 2>/dev/null || true
    echo "‚úÖ CSS copiado: $(ls _site/assets/css/*.css 2>/dev/null | wc -l) archivos"
    fi
    
    # JS si existe
    if [ -d "assets/js" ]; then
    mkdir -p _site/assets/js
    cp assets/js/*.js _site/assets/js/ 2>/dev/null || true
    echo "‚úÖ JavaScript copiado"
    elif [ -d "js" ]; then
    cp -r js _site/ 2>/dev/null || true
    echo "‚úÖ JavaScript copiado desde js/"
    fi
    
    # Im√°genes
    if [ -d "assets/images" ]; then
    mkdir -p _site/assets/images
    cp -r assets/images/* _site/assets/images/ 2>/dev/null || true
    echo "‚úÖ Im√°genes copiadas"
    elif [ -d "images" ]; then
    cp -r images _site/ 2>/dev/null || true
    echo "‚úÖ Im√°genes copiadas desde images/"
    fi
    
    # Iconos
    if [ -d "assets/icons" ]; then
    mkdir -p _site/assets/iconss
    cp -r assets/icons/* _site/assets/icons/ 2>/dev/null || true
    echo "‚úÖ Iconos copiadas"
    elif [ -d "icons" ]; then
    cp -r icons _site/ 2>/dev/null || true
    echo "‚úÖ Iconos copiadas desde images/"
    fi
    
    # Fuentes
    if [ -d "assets/fonts" ]; then
    mkdir -p _site/assets/fonts
    cp -r assets/fonts/* _site/assets/fonts/ 2>/dev/null || true
    echo "‚úÖ Fuentes copiadas"
    elif [ -d "fonts" ]; then
    cp -r fonts _site/ 2>/dev/null || true
    echo "‚úÖ Fuentes copiadas desde fonts/"
    fi
    
    # 4. VERIFICAR ESTRUCTURA FINAL
    echo ""
    echo "=== ESTRUCTURA FINAL DEL SITIO ==="
    echo "_site/"
    find _site -type f | sort
    
    echo ""
    echo "=== RESUMEN ==="
    echo "üìÑ Landing page: _site/index.html"
    echo "üá™üá∏ Espa√±ol: $(ls _site/es/*.html 2>/dev/null | wc -l) p√°ginas"
    echo "üá¨üáß Ingl√©s: $(ls _site/en/*.html 2>/dev/null | wc -l) p√°ginas"
    echo "üá´üá∑ Franc√©s: $(ls _site/fr/*.html 2>/dev/null | wc -l) p√°ginas"
    echo "üé® CSS: $(ls _site/assets/css/*.css 2>/dev/null | wc -l) archivos"
      - name: üì¶ Crear artifact de compilaci√≥n
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: _site/
          retention-days: 7
        if: success()

  deploy:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Descargar artifact del build
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: _site/

      - name: ‚úÖ Verificar archivos para deploy
        run: |
          echo "=== ARCHIVOS PARA DEPLOY ==="
          ls -la _site/
          if [ ! -d "_site/assets" ] && [ ! -f "_site/index.html" ]; then
            echo "‚ö†Ô∏è Advertencia: No hay index.html ni assets"
          fi
          echo ""
          echo "=== ESTRUCTURA COMPLETA ==="
          find _site -type f | sort

      - name: üöÄ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site  # ‚úÖ CAMBIO IMPORTANTE: Solo la carpeta preparada
          force_orphan: true    # ‚úÖ Ahora s√≠ funciona porque _site no tiene .git
          publish_branch: gh-pages

      - name: üì¢ Notificar despliegue
        run: |
          echo "‚úÖ Sitio desplegado en GitHub Pages"
          echo "üåê URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"