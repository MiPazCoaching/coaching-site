name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

# Evitar ejecuciones concurrentes en el mismo commit
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Para tener todo el historial de git

      - name: â” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --no-audit --prefer-offline
          echo "âœ… Dependencias instaladas"

      - name: ğŸ” Check dependencies
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Gulp version: $(npx gulp --version)"
          npm list gulp gulp-sass sass --depth=0 || echo "Algunas dependencias pueden faltar"

      - name: ğŸ§¹ Clean previous builds
        run: |
          if [ -d "assets/css" ]; then
            rm -rf assets/css/*
            echo "âœ… Directorio CSS limpiado"
          else
            mkdir -p assets/css
            echo "âœ… Directorio CSS creado"
          fi

      - name: ğŸ¨ Compile SCSS (Development)
        run: npm run build
        env:
          NODE_ENV: development

      - name: ğŸ“„ Verify development build
        run: |
          if [ -f "assets/css/main.css" ]; then
            echo "âœ… main.css generado"
            echo "TamaÃ±o: $(wc -l < assets/css/main.css) lÃ­neas"
          else
            echo "âŒ main.css no generado"
            exit 1
          fi

      - name: ğŸ§¹ Clean for production
        run: |
          rm -rf assets/css/*

      - name: ğŸ­ Compile SCSS (Production)
        run: npm run build:prod
        env:
          NODE_ENV: production

      - name: âœ… Verify production build
        run: |
          echo "=== Verificando build de producciÃ³n ==="
          
          # Verificar archivos principales
          if [ ! -f "assets/css/main.css" ]; then
            echo "âŒ main.css no existe"
            exit 1
          fi
          
          if [ ! -f "assets/css/main.min.css" ]; then
            echo "âš ï¸  main.min.css no generado (puede ser normal si no hay PostCSS)"
          fi
          
          # Mostrar informaciÃ³n de los archivos
          echo "ğŸ“ Contenido del directorio CSS:"
          ls -la assets/css/
          
          echo "ğŸ“Š TamaÃ±o de main.css:"
          wc -l assets/css/main.css || echo "No se pudo contar lÃ­neas"
          
          echo "âœ… Build de producciÃ³n verificado"

      - name: ğŸ“¦ Create build artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiled-css
          path: assets/css/
          retention-days: 7

  deploy:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Necesario para hacer push a gh-pages
    
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --no-audit

      - name: ğŸ­ Build for production
        run: npm run build:prod
        env:
          NODE_ENV: production

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./  # Publica todo el repositorio
          destination_dir: .  # No cambia la estructura
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ğŸš€ Deploy: ${{ github.event.head_commit.message || github.sha }}'
          force_orphan: true  # Mantiene limpia la rama gh-pages
          # Excluir archivos que no necesitan estar en Pages
          exclude_assets: 'node_modules/,.github/,.git/,src/,*.md,package*.json,gulpfile.js'

      - name: ğŸ“¢ Notify deployment
        run: |
          echo "âœ… Sitio desplegado en GitHub Pages"
          echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "ğŸ“… Fecha: $(date)"