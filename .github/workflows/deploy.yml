name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --no-audit
          echo "âœ… Dependencias instaladas"

      - name: ğŸ¨ Compilar SCSS
        run: |
          echo "=== COMPILANDO SCSS ==="
          npx gulp styles 2>&1
          
          # Verificar que se generÃ³ el CSS
          if [ -f "assets/css/main.css" ]; then
            echo "âœ… CSS compilado correctamente"
            echo "ğŸ“Š TamaÃ±o: $(wc -l < assets/css/main.css) lÃ­neas"
          else
            echo "âŒ ERROR: No se generÃ³ main.css"
            exit 1
          fi

      - name: ğŸ’¾ Subir CSS compilado al repositorio
        run: |
          echo "=== SUBIENDO CSS AL REPOSITORIO ==="
          
          # Configurar git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Verificar cambios
          git status
          
          # Agregar solo el CSS compilado
          if git diff --name-only | grep -q "assets/css/main.css"; then
            echo "ğŸ“¦ CSS modificado, subiendo cambios..."
            git add assets/css/main.css
            git commit -m "ğŸ”„ Actualizar CSS compilado [skip ci]"
          
            # Subir cambios
            git push origin HEAD:${{ github.ref }}
            echo "âœ… CSS subido al repositorio"
          else
            echo "ğŸ“­ No hay cambios en el CSS"
          
      - name: ğŸ”¨ Compilar Nunjucks a HTML
        run: |
          echo "=== COMPILANDO NUNJUCKS A HTML ==="
          
          # Crear directorio para pÃ¡ginas HTML
          mkdir -p src/pages
          
          # Instalar nunjucks si no estÃ¡ en package.json
          if ! npm list nunjucks >/dev/null 2>&1; then
            npm install nunjucks --no-save
          fi
          
          # Crear script de compilaciÃ³n
          cat > compile-njk.js << 'EOF'
          const nunjucks = require('nunjucks');
          const fs = require('fs');
          const path = require('path');

          // Configurar Nunjucks
          const templatesDir = 'src/templates';
          const outputDir = 'src/pages';
          
          // Crear entorno de Nunjucks
          const env = nunjucks.configure(templatesDir, {
            autoescape: false,
            throwOnUndefined: false,
            trimBlocks: true,
            lstripBlocks: true
          });

          // FunciÃ³n para procesar todas las pÃ¡ginas
          function compilePages() {
            const languages = ['es', 'en', 'fr'];
            const pages = ['index', 'about', 'services', 'contact', 'blog'];
          
            languages.forEach(lang => {
              const langDir = path.join(outputDir, lang);
              if (!fs.existsSync(langDir)) {
                fs.mkdirSync(langDir, { recursive: true });
              }
          
              pages.forEach(page => {
                const templatePath = path.join(templatesDir, 'pages', lang, `${page}.njk`);
          
                if (fs.existsSync(templatePath)) {
                  try {
                    // Cargar datos de traducciÃ³n
                    const translations = require(`./locales/${lang}.json`);
          
                    // Datos para la plantilla
                    const data = {
                      lang: lang,
                      slug: page === 'index' ? '' : page,
                      title: `${page.charAt(0).toUpperCase() + page.slice(1)} - Marta Paz Ogle`,
                      t: translations,
                      asset: (filepath) => `../${filepath}`,
                      url: (pageName, pageLang = lang) => `/${pageLang}/${pageName === 'home' ? '' : pageName}.html`
                    };
          
                    // Renderizar plantilla
                    const html = env.render(`pages/${lang}/${page}.njk`, data);
          
                    // Guardar HTML
                    const outputPath = path.join(langDir, `${page === 'index' ? 'index' : page}.html`);
                    fs.writeFileSync(outputPath, html);
          
                    console.log(`âœ… ${lang}/${page}.njk -> ${lang}/${page}.html`);
                  } catch (error) {
                    console.error(`âŒ Error compilando ${templatePath}:`, error.message);
                  }
                }
              });
            });
          }

          compilePages();
          EOF
          
          # Ejecutar compilaciÃ³n
          node compile-njk.js
          
          # Verificar que se generaron los HTML
          echo ""
          echo "=== ARCHIVOS GENERADOS ==="
          find src/pages -name "*.html" | sort

      - name: ğŸ—‚ï¸ Preparar archivos para Pages
        run: |
          echo "=== PREPARANDO PARA GITHUB PAGES ==="
          
          # Crear directorio para el deploy
          mkdir -p _site
          
          # 1. COPIAR PÃGINAS HTML COMPILADAS
          echo "=== COPIANDO PÃGINAS COMPILADAS ==="
          
          if [ -d "src/pages" ]; then
            echo "ğŸ“ Copiando estructura de pÃ¡ginas..."
          
            # Copiar todas las pÃ¡ginas HTML
            cp -r src/pages/* _site/ 2>/dev/null || true
          
            # Crear redirecciÃ³n desde root
            cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta http-equiv="refresh" content="0; url=/es/">
              <title>Redireccionando...</title>
              <script>
                  // Detectar idioma del navegador
                  const userLang = navigator.language || navigator.userLanguage;
                  const supportedLangs = ['es', 'en', 'fr'];
                  let defaultLang = 'es';
          
                  if (userLang.startsWith('en')) defaultLang = 'en';
                  if (userLang.startsWith('fr')) defaultLang = 'fr';
          
                  window.location.href = `/${defaultLang}/`;
              </script>
          </head>
          <body>
              <p>Redireccionando a tu idioma preferido...</p>
              <p>Si no eres redireccionado automÃ¡ticamente, haz clic en:</p>
              <ul>
                  <li><a href="/es/">EspaÃ±ol</a></li>
                  <li><a href="/en/">English</a></li>
                  <li><a href="/fr/">FranÃ§ais</a></li>
              </ul>
          </body>
          </html>
          EOF
          fi
          
          # 2. COPIAR ASSETS
          if [ -d "assets" ]; then
            cp -r assets _site/
            echo "âœ… Assets copiados"
          fi
          
          # 3. AGREGAR .nojekyll PARA DESHABILITAR JEKYLL
          touch _site/.nojekyll
          echo "âœ… Archivo .nojekyll creado"
          
          # 4. VERIFICAR
          echo ""
          echo "=== ESTRUCTURA FINAL ==="
          find _site -type f | sort | head -20

      - name: ğŸ“¦ Crear artifact de compilaciÃ³n
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: _site/
          retention-days: 7

  deploy:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Descargar artifact del build
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: _site/

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          force_orphan: true
          publish_branch: gh-pages
          cname: # Agregar aquÃ­ dominio

      - name: ğŸ“¢ Notificar despliegue
        run: |
          echo "âœ… Sitio desplegado en GitHub Pages"
          echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"