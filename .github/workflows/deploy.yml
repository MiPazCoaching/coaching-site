name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --no-audit
          echo "âœ… Dependencias instaladas"

      - name: ğŸ¨ Compilar SCSS
        run: |
          echo "=== COMPILANDO SCSS ==="
          npx gulp styles 2>&1
          
          # Verificar que se generÃ³ el CSS
          if [ -f "assets/css/main.css" ]; then
            echo "âœ… CSS compilado correctamente"
            echo "ğŸ“Š TamaÃ±o: $(wc -l < assets/css/main.css) lÃ­neas"
          else
            echo "âŒ ERROR: No se generÃ³ main.css"
            exit 1
          fi

      - name: ğŸ’¾ Subir CSS compilado al repositorio
        run: |
          echo "=== SUBIENDO CSS AL REPOSITORIO ==="
          
          # Configurar git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Verificar cambios
          git status
          
          # Agregar solo el CSS compilado
          if git diff --name-only | grep -q "assets/css/main.css"; then
            echo "ğŸ“¦ CSS modificado, subiendo cambios..."
            git add assets/css/main.css
            git commit -m "ğŸ”„ Actualizar CSS compilado [skip ci]"
          
            # Subir cambios
            git push origin HEAD:${{ github.ref }}
            echo "âœ… CSS subido al repositorio"
          else
            echo "ğŸ“­ No hay cambios en el CSS"
          fi

      - name: ğŸ—‚ï¸ Preparar archivos para Pages
        run: |
          echo "=== PREPARANDO PARA GITHUB PAGES ==="
          
          # Crear directorio para el deploy
          mkdir -p _site
          
          # 1. COPIAR PÃGINAS HTML ORGANIZADAS POR IDIOMAS
          echo "=== COPIANDO PÃGINAS POR IDIOMAS ==="
          
          if [ -d "src/pages" ]; then
            echo "ğŸ“ Estructura encontrada: src/pages/"
          
            # EspaÃ±ol (es)
            if [ -d "src/pages/es" ]; then
              mkdir -p _site/es
              cp src/pages/es/*.html _site/es/ 2>/dev/null || true
              echo "âœ… EspaÃ±ol copiado"
            fi
          
            # InglÃ©s (en)
            if [ -d "src/pages/en" ]; then
              mkdir -p _site/en
              cp src/pages/en/*.html _site/en/ 2>/dev/null || true
              echo "âœ… InglÃ©s copiado"
            fi
          
            # FrancÃ©s (fr)
            if [ -d "src/pages/fr" ]; then
              mkdir -p _site/fr
              cp src/pages/fr/*.html _site/fr/ 2>/dev/null || true
              echo "âœ… FrancÃ©s copiado"
            fi
          fi
          
          # 2. COPIAR LANDING PAGE
          if [ -f "index.html" ]; then
            cp index.html _site/
            echo "âœ… Landing page copiada"
          fi
          
          # 3. COPIAR ASSETS
          if [ -d "assets" ]; then
            cp -r assets _site/
            echo "âœ… Assets copiados"
          fi
          
          # 4. VERIFICAR
          echo ""
          echo "=== ESTRUCTURA FINAL ==="
          find _site -type f | sort

      - name: ğŸ“¦ Crear artifact de compilaciÃ³n
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: _site/
          retention-days: 7

  deploy:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Descargar artifact del build
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: _site/

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          force_orphan: true
          publish_branch: gh-pages

      - name: ğŸ“¢ Notificar despliegue
        run: |
          echo "âœ… Sitio desplegado en GitHub Pages"
          echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"